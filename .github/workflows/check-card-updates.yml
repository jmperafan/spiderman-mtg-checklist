name: Check for Card Updates

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    name: Check Scryfall for Card Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Backup current cards.json
        run: |
          cp backend/data/cards.json backend/data/cards.json.backup
          echo "Backed up cards.json"

      - name: Fetch latest cards from Scryfall
        run: |
          node scripts/fetch-cards.js
          echo "Fetched latest card data"

      - name: Check for differences
        id: check_diff
        run: |
          if ! diff -q backend/data/cards.json backend/data/cards.json.backup > /dev/null; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "Card data has changed!"

            # Count differences
            OLD_COUNT=$(cat backend/data/cards.json.backup | node -e "const fs=require('fs'); let data=''; process.stdin.on('data', d=>data+=d); process.stdin.on('end', ()=>console.log(JSON.parse(data).length))")
            NEW_COUNT=$(cat backend/data/cards.json | node -e "const fs=require('fs'); let data=''; process.stdin.on('data', d=>data+=d); process.stdin.on('end', ()=>console.log(JSON.parse(data).length))")

            echo "old_count=$OLD_COUNT" >> $GITHUB_OUTPUT
            echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "No changes detected in card data"
          fi

      - name: Run validation tests on new data
        if: steps.check_diff.outputs.changes_detected == 'true'
        run: npm test

      - name: Create summary
        if: always()
        run: |
          echo "### Card Update Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_diff.outputs.changes_detected }}" == "true" ]; then
            echo "ğŸ”„ **Changes Detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Previous card count: ${{ steps.check_diff.outputs.old_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- New card count: ${{ steps.check_diff.outputs.new_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- Difference: $((${{ steps.check_diff.outputs.new_count }} - ${{ steps.check_diff.outputs.old_count }}))" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No Changes** - Card data is up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Remove backup file
        if: steps.check_diff.outputs.changes_detected == 'true'
        run: rm backend/data/cards.json.backup

      - name: Commit and push changes
        if: steps.check_diff.outputs.changes_detected == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b update-card-data
          git add backend/data/cards.json
          git commit -m "Update card data from Scryfall

          Automated update detected ${{ steps.check_diff.outputs.new_count }} cards (was ${{ steps.check_diff.outputs.old_count }})"
          git push -f origin update-card-data

      - name: Create Pull Request via gh CLI
        if: steps.check_diff.outputs.changes_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          if gh pr view update-card-data 2>/dev/null; then
            echo "PR already exists, updating..."
            gh pr edit update-card-data --title "ğŸ”„ Update Marvel Spider-Man card data" --body "$(cat <<'EOF'
          ## Card Data Update

          This PR was automatically created because new or updated card data was detected from Scryfall.

          ### Changes:
          - **Previous count:** ${{ steps.check_diff.outputs.old_count }} cards
          - **New count:** ${{ steps.check_diff.outputs.new_count }} cards
          - **Difference:** $((${{ steps.check_diff.outputs.new_count }} - ${{ steps.check_diff.outputs.old_count }})) cards

          ### Validation:
          The card validation tests have been run automatically. Please review the test results below.
          EOF
          )"
          else
            echo "Creating new PR..."
            gh pr create \
              --title "ğŸ”„ Update Marvel Spider-Man card data" \
              --body "$(cat <<'EOF'
          ## Card Data Update

          This PR was automatically created because new or updated card data was detected from Scryfall.

          ### Changes:
          - **Previous count:** ${{ steps.check_diff.outputs.old_count }} cards
          - **New count:** ${{ steps.check_diff.outputs.new_count }} cards
          - **Difference:** $((${{ steps.check_diff.outputs.new_count }} - ${{ steps.check_diff.outputs.old_count }})) cards

          ### Validation:
          The card validation tests have been run automatically. Please review the test results below.
          EOF
          )" \
              --base main \
              --head update-card-data \
              --label automated,card-data
          fi
